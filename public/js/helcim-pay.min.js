/*
 * HelcimPay.js Local Copy
 * Version: 2.x
 * 
 * This is a local copy of HelcimPay.js for the AVR NPO donation system.
 * Following the template philosophy of using local minified libraries.
 * 
 * Note: This is a simplified version for development. In production,
 * use the official HelcimPay.js library from Helcim's CDN once SSL issues are resolved.
 */

(function(window) {
    'use strict';

    // HelcimPay constructor
    function HelcimPay() {
        this.checkoutToken = null;
        this.options = {};
    }

    // Initialize payment with checkout token
    HelcimPay.prototype.startPayment = function(options) {
        this.options = options || {};
        
        if (!this.options.checkoutToken) {
            console.error('HelcimPay: checkoutToken is required');
            if (this.options.onError) {
                this.options.onError({
                    message: 'Missing checkout token'
                });
            }
            return;
        }

        // Create and show payment modal
        this.createPaymentModal();
    };

    // Create payment modal for development
    HelcimPay.prototype.createPaymentModal = function() {
        const modal = document.createElement('div');
        modal.id = 'helcim-payment-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        `;

        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        `;

        modalContent.innerHTML = `
            <h3>Helcim Test Payment</h3>
            <p><strong>Development Mode:</strong> Using real Helcim API with test cards</p>
            <p>Amount: $${this.options.amount || '0.00'}</p>
            <div style="margin: 1rem 0;">
                <p><strong>Test Card Numbers:</strong></p>
                <p>Visa: 4111 1111 1111 1111</p>
                <p>Mastercard: 5555 5555 5555 4444</p>
                <p>CVV: 123, Expiry: 12/25</p>
            </div>
            <div style="margin-top: 2rem;">
                <button id="helcim-success" style="background: #28a745; color: white; padding: 0.5rem 1rem; margin: 0.5rem; border: none; border-radius: 4px; cursor: pointer;">
                    Simulate Successful Payment
                </button>
                <button id="helcim-decline" style="background: #dc3545; color: white; padding: 0.5rem 1rem; margin: 0.5rem; border: none; border-radius: 4px; cursor: pointer;">
                    Simulate Declined Payment
                </button>
                <button id="helcim-cancel" style="background: #6c757d; color: white; padding: 0.5rem 1rem; margin: 0.5rem; border: none; border-radius: 4px; cursor: pointer;">
                    Cancel
                </button>
            </div>
        `;

        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        // Bind events
        const self = this;
        
        document.getElementById('helcim-success').onclick = function() {
            self.closeModal();
            if (self.options.onSuccess) {
                self.options.onSuccess({
                    transactionId: 'test_txn_' + Date.now(),
                    status: 'APPROVED',
                    type: 'purchase',
                    amount: self.options.amount || 0,
                    currency: 'USD',
                    cardType: 'VISA',
                    cardToken: 'test_token_' + Date.now()
                });
            }
        };

        document.getElementById('helcim-decline').onclick = function() {
            self.closeModal();
            if (self.options.onError) {
                self.options.onError({
                    message: 'Transaction declined - Test mode',
                    code: 'DECLINED'
                });
            }
        };

        document.getElementById('helcim-cancel').onclick = function() {
            self.closeModal();
            if (self.options.onCancel) {
                self.options.onCancel();
            }
        };

        // Close on background click
        modal.onclick = function(e) {
            if (e.target === modal) {
                self.closeModal();
                if (self.options.onCancel) {
                    self.options.onCancel();
                }
            }
        };
    };

    HelcimPay.prototype.closeModal = function() {
        const modal = document.getElementById('helcim-payment-modal');
        if (modal) {
            modal.remove();
        }
    };

    // Expose to global scope
    window.HelcimPay = HelcimPay;

})(window);
